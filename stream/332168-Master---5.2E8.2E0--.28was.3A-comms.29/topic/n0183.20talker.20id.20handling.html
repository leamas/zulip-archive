<html>
<head><meta charset="utf-8"><title>n0183 talker id handling · Master - 5.8.0  (was: comms) · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/index.html">Master - 5.8.0  (was: comms)</a></h2>
<h3>Topic: <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html">n0183 talker id handling</a></h3>

<hr>

<base href="https://opencpn.zulipchat.com">

<head><link href="https://leamas.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="294262176"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294262176" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294262176">(Aug 19 2022 at 13:13)</a>:</h4>
<p>We (well, really I) seems to have a mess when it comes to n0183 types.  As of now, Dave just removes the talker id and uses only message type. On the other hand I have used  the complete id (talker id + message, 5 chars). Needless to say, this is not compatible.</p>
<p>Furthermore, none of these approaches is IMHO right. My is wrong since listeners are not really interested in the talker ID. Dave's is wrong since it throws away the talker id, an item which might be needed in a later stage for example when prioritizing.</p>
<p>I''l make a stab  on this in the message definition and CTOR.</p>



<a name="294278699"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294278699" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294278699">(Aug 19 2022 at 14:33)</a>:</h4>
<p><span class="user-mention" data-user-id="517002">@Dave Register</span>  Pushed first  iteration of these changes. Still some rough corners, but should basically be OK.</p>
<p>One change in  comm_bridge.cpp which I cannot see through. Would be glad if you reviewed that change.</p>
<p>Commit under way.</p>



<a name="294278984"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294278984" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294278984">(Aug 19 2022 at 14:35)</a>:</h4>
<p><span class="user-mention" data-user-id="518981">@Github Bot</span>  #007fc0f54</p>



<a name="294278987"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294278987" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Github Bot <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294278987">(Aug 19 2022 at 14:35)</a>:</h4>
<p>** author: Alec Leamas at 2022-08-19T14:30:42Z<br>
navmsg.h and what not: Handle updates nmea0183 talker id changes.<br>
<a href="https://github.com/OpenCPN/OpenCPN/commit/007fc0f54">https://github.com/OpenCPN/OpenCPN/commit/007fc0f54</a></p>



<a name="294286160"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294286160" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan Svensson <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294286160">(Aug 19 2022 at 15:12)</a>:</h4>
<p>For N0183 the talker normally bare no information about transferred data so no need to use that. But O knows it since the NMEA parser is collecting it. Since it can change or has arbitrary treatment from different device producers it's nothing to rely on.<br>
The NMEA0183 standard has though now made a deviation for the GGA and GSV messages. If GGA use talker GN to construct GNGGA the GN part tells "Number of satellites in use" is a combination of several satellite system and talker GP says only one system is used. <br>
For GSV the talker "GP" is the status for the GPS system and "GA" the Glonass system and so on. See for example the Dashboard gps.cpp based on: <a href="https://www.nmea.org/Assets/20190515%20nmea%200183%20gsv%20sentence%20corrections.pdf">The GSV part here.</a></p>



<a name="294286816"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294286816" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294286816">(Aug 19 2022 at 15:15)</a>:</h4>
<p>My point is not how or if it should be used, just that we should not throw it away when sending upwards in the stack. This is now fixed, first iteration, there are  'type' and 'talker' fields instead of a single 'id'.   This is a necessary first step to make any conclusions like those you describe.</p>



<a name="294335003"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294335003" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294335003">(Aug 19 2022 at 17:54)</a>:</h4>
<p><span class="user-mention" data-user-id="399510">@Alec Leamas</span> <br>
Your latest commit OK, with minor tweaks to serial driver and CommBridge.<br>
"this identifier" is used to detect and prioritize between, for example, position data from both XXRMC and AIVDO.  Or, between GPRMC and IIRMC.  So it needs to have the Talker embedded in the string.</p>



<a name="294336106"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294336106" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294336106">(Aug 19 2022 at 18:00)</a>:</h4>
<p>More:<br>
The latest changes have broken the ability to listen to "all" N0183 messages.  We still need that for legacy plugin support.<br>
Thoughts?</p>



<a name="294406771"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294406771" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294406771">(Aug 20 2022 at 08:11)</a>:</h4>
<p>You did want my thoughts yesterday, dinner party here, wine...</p>
<p>Sorry, I missed this usecase. One thought is that there is no test for this. If there  was, it would not  have happened.</p>
<p>When it comes to solution, IIRC we used "" as message type when handling the "all n0183" messages stream. I think it would be better to use an id which was still  a  legal three character string such as "ALL" ("ANY" or even "***"  should also work).  Sticking to the basic rules would make these kind of regressions less likely.</p>
<p>For consistency, I also suggest that we keep the talker id when sending to "ALL" i. e,  "GPGGA" -&gt; "GPALL"</p>
<p>To implement, the solution would be to add a new Nmea0183Msg constructor like <code>Nmea0183Msg(const Nmea0183Msg&amp; other,  const std:.string&amp; t)</code> which creates a new message copy with a new type.</p>
<p>Would this be OK?</p>
<p>Alternatives includes  giving some special meaning to using ("", "") as  talker/message and make it possible to listen to "". However, it seems more convoluted to me.</p>



<a name="294441634"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294441634" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294441634">(Aug 20 2022 at 13:27)</a>:</h4>
<p>Sounds good to me.  Not sure why we need a new copy CTOR, though seems logical for completeness of the class.  I await your patch.</p>



<a name="294447721"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294447721" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294447721">(Aug 20 2022 at 14:21)</a>:</h4>
<p>The CTOR is just for convenience, it's hard to modify . I have pushed the new CTOR, but don't find the places where the notify/listen is applied. Basically, we should now have on the sending, notify side:</p>
<div class="codehilite"><pre><span></span><code>-    auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(&quot;&quot;, full_sentence,
+    auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(&quot;ALL&quot;, full_sentence,
</code></pre></div>
<p>And on the receiving, listening side something like (after declaring  listener_all0183 and EVT_ALL_N0183):</p>
<div class="codehilite"><pre><span></span><code>Nmea0183Msg n0183_msg_VTG(&quot;VTG&quot;);
 listener_N0183_VTG = msgbus.GetListener(EVT_N0183_VTG, this, n0183_msg_VTG);
listener_all0183 = msgbus.GetListener(EVT_ALL_N0183, this, Nmea0183Msg(n0183_msg_VTG, &quot;ALL&quot;));
</code></pre></div>
<p>Sorry, just no time to read the code more thoroughly  now,  more dinners ahead,  so this is what I have. If you can wait I can apply the necessary changes tomorrow.</p>



<a name="294450412"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294450412" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294450412">(Aug 20 2022 at 14:46)</a>:</h4>
<p>OK, I'll give that a try.<br>
Have fun.</p>



<a name="294503979"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294503979" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294503979">(Aug 21 2022 at 03:35)</a>:</h4>
<p>I fiddled about.  I found that the first argument in Nmea0183Msg CTOR really want to be 5 characters.</p>



<a name="294504051"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294504051" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294504051">(Aug 21 2022 at 03:36)</a>:</h4>
<p>So I tried:</p>
<div class="codehilite"><pre><span></span><code>auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(&quot;XXALL&quot;, full_sentence,.....
</code></pre></div>

<p>And in the listener:</p>
<div class="codehilite"><pre><span></span><code>listener_all0183 = msgbus.GetListener(EVT_ALL_N0183, this, Nmea0183Msg(n0183_msg_VTG, &quot;XXALL&quot;));
</code></pre></div>

<p>and it worked.</p>



<a name="294504172"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294504172" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294504172">(Aug 21 2022 at 03:39)</a>:</h4>
<p>So, from my view, this is all right now, if a little obtuse.</p>



<a name="294514656"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294514656" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294514656">(Aug 21 2022 at 07:12)</a>:</h4>
<p>hm... yes, the thought occurred to me later, despite that  I actually should be thinking about other things at that point.</p>
<blockquote>
<p>if a little obtuse.</p>
</blockquote>
<p>too obtuse IMO. Will try to make a fix.</p>



<a name="294579095"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294579095" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan Svensson <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294579095">(Aug 21 2022 at 19:51)</a>:</h4>
<p>On Win VS2017<br>
Current comm code builds wo error but running debug crash here:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>  [Inline Frame] opencpn.exe!std::_Ptr_base&lt;NavAddr&gt;::_Copy_construct_from(const std::shared_ptr&lt;NavAddr&gt; &amp;) Line 1079    C++
[Inline Frame] opencpn.exe!std::shared_ptr&lt;NavAddr&gt;::{ctor}(const std::shared_ptr&lt;NavAddr&gt; &amp;) Line 1335 C++
[Inline Frame] opencpn.exe!Nmea0183Msg::{ctor}(const Nmea0183Msg &amp;) Line 195    C++
opencpn.exe!std::make_unique&lt;Nmea0183Msg const ,Nmea0183Msg const &amp;,char const (&amp;)[4],0&gt;(const Nmea0183Msg &amp;  _Args_0&gt;, const char[4] &amp; &lt;_Args_1&gt;) Line 2539    C++
opencpn.exe!CommDriverN0183Serial::handle_N0183_MSG(CommDriverN0183SerialEvent &amp; event) Line 311    C++
[External Code] 
[Frames below may be incorrect and/or missing, no symbols loaded for wxbase312u_vc_custom.dll]  Unknown
opencpn.exe!WinMain(HINSTANCE__ * hInstance, HINSTANCE__ * hPrevInstance, char * __formal, int nCmdShow) Line 943   C++
[External Code]
</code></pre></div>

</blockquote>
<p><a href="/user_uploads/33951/rVuSoRuVdwZUoJDH2s4ij2e2/bild.png">bild.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/33951/rVuSoRuVdwZUoJDH2s4ij2e2/bild.png" title="bild.png"><img src="/user_uploads/33951/rVuSoRuVdwZUoJDH2s4ij2e2/bild.png"></a></div>



<a name="294582332"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294582332" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294582332">(Aug 21 2022 at 20:45)</a>:</h4>
<p><span class="user-mention" data-user-id="522486">@Håkan Svensson</span>     hm... seems like  a recent problem.  Could you possibly make a bisect to find the failing commit?</p>



<a name="294582487"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294582487" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294582487">(Aug 21 2022 at 20:48)</a>:</h4>
<p>No, wait... line 311 is a recent change, I know when it happened.</p>



<a name="294584770"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294584770" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294584770">(Aug 21 2022 at 21:30)</a>:</h4>
<p>OK, I have  test case, and have found a bug. Will push a fix. However, this bug should not make it crash...</p>



<a name="294587402"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294587402" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294587402">(Aug 21 2022 at 22:27)</a>:</h4>
<p>Pushed changes to the very line where the  crash occurred. However, the crash is probably still there, I cannot see how the changes I have done would fix a  crash.</p>



<a name="294590857"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294590857" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294590857">(Aug 21 2022 at 23:50)</a>:</h4>
<p><span class="user-mention" data-user-id="399510">@Alec Leamas</span>  <br>
Sorry, the Nmea0183Msg copy constructor with type change (pluginmanager "ALL")causes a crash on linux.  Don't know why.  Too many smart pointers for me to follow.</p>



<a name="294606224"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294606224" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294606224">(Aug 22 2022 at 05:13)</a>:</h4>
<p><span class="user-mention" data-user-id="517002">@Dave Register</span>  <span class="user-mention" data-user-id="522486">@Håkan Svensson</span>  As I understand it you are both reporting the same thing .</p>
<p>I pushed some changes late yesterday. <span class="user-mention" data-user-id="517002">@Dave Register</span> : Did you test against master @0c37a7267?<br>
<span class="user-mention" data-user-id="522486">@Håkan Svensson</span> Does problem persist even with the latest changes?</p>
<p>I have a working test case in tests.cpp around line 161 and 405. If this persists (which I think it does) we need to figure out the difference.</p>



<a name="294609486"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294609486" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294609486">(Aug 22 2022 at 05:51)</a>:</h4>
<p><span class="user-mention" data-user-id="522486">@Håkan Svensson</span>  Currently, it won't fail since Dave has commented out the failing line. Could you please try the following patch against  current master @5a3476de3 and report back?</p>
<div class="codehilite"><pre><span></span><code>diff --git a/src/comm_drv_n0183_serial.cpp b/src/comm_drv_n0183_serial.cpp
index 72fd090f8..99439342c 100644
--- a/src/comm_drv_n0183_serial.cpp
+++ b/src/comm_drv_n0183_serial.cpp
@@ -308,9 +308,8 @@ void CommDriverN0183Serial::handle_N0183_MSG(

     // Also notify for &quot;all&quot; N0183 messages, to support plugin API using
     // original talker id
-    // FIXME
-    //auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(*msg, &quot;ALL&quot;);
-    //m_listener.Notify(std::move(msg_all));
+    auto msg_all = std::make_shared&lt;const Nmea0183Msg&gt;(*msg, &quot;ALL&quot;);
+    m_listener.Notify(std::move(msg_all));
   }
 }
</code></pre></div>



<a name="294609981"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294609981" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan Svensson <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294609981">(Aug 22 2022 at 05:57)</a>:</h4>
<p>First:<br>
Built with latest commits.<br>
The debug hang/crash is now gone and O is running again.</p>



<a name="294610447"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294610447" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294610447">(Aug 22 2022 at 06:02)</a>:</h4>
<blockquote>
<p>The debug hang/crash is now gone and O is running again.</p>
</blockquote>
<p>Yes, but this is because Dave has completely disabled the listening to ALL. This just a temporary work-around, it must be handled in another way.  To that end, could you test the patch?</p>



<a name="294610514"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294610514" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan Svensson <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294610514">(Aug 22 2022 at 06:03)</a>:</h4>
<p>Second:<br>
With the change of the diff above the debug run hangs at:</p>
<blockquote>
<p>[Inline Frame] opencpn.exe!std::_Ptr_base&lt;NavAddr&gt;::_Copy_construct_from(const std::shared_ptr&lt;NavAddr&gt; &amp;) Line 1079    C++<br>
    [Inline Frame] opencpn.exe!std::shared_ptr&lt;NavAddr&gt;::{ctor}(const std::shared_ptr&lt;NavAddr&gt; &amp;) Line 1335 C++<br>
    [Inline Frame] opencpn.exe!Nmea0183Msg::{ctor}(const Nmea0183Msg &amp;) Line 195    C++<br>
    [Inline Frame] opencpn.exe!std::_Ref_count_obj&lt;Nmea0183Msg const &gt;::{ctor}(const Nmea0183Msg &amp;) Line 1801   C++<br>
    opencpn.exe!std::make_shared&lt;Nmea0183Msg const ,Nmea0183Msg const &amp;,char const (&amp;)[4]&gt;(const Nmea0183Msg &amp; &lt;_Args_0&gt;, const char[4] &amp; &lt;_Args_1&gt;) Line 1866  C++<br>
    opencpn.exe!CommDriverN0183Serial::handle_N0183_MSG(CommDriverN0183SerialEvent &amp; event) Line 314    C++<br>
    [External Code] <br>
    [Frames below may be incorrect and/or missing, no symbols loaded for wxbase312u_vc_custom.dll]  Unknown<br>
    opencpn.exe!WinMain(HINSTANCE__ * hInstance, HINSTANCE__ * hPrevInstance, char * __formal, int nCmdShow) Line 945   C++<br>
    [External Code] </p>
</blockquote>
<p>If I again comment out the two lines the debug runs wo hangs.</p>



<a name="294611845"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294611845" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294611845">(Aug 22 2022 at 06:19)</a>:</h4>
<p>OK. Back to the drawing board. The question is: What is the difference with the test case?</p>



<a name="294612959"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294612959" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294612959">(Aug 22 2022 at 06:30)</a>:</h4>
<p>OK, here is a new patch, unfortunately  a bit bigger. Could you possibly...</p>
<div class="codehilite"><pre><span></span><code>commit 4bef446bc02731362052a917abf12eb0bad6d6fc
Author: Alec Leamas &lt;leamas.alec@nowhere.net&gt;
Date:   Mon Aug 22 07:45:08 2022 +0200

    tests: testing &quot;ALL&quot; n0183 messages: make_unique -&gt; make_shared.

diff --git a/include/comm_navmsg.h b/include/comm_navmsg.h
index 0264a850b..d02b8ae76 100644
--- a/include/comm_navmsg.h
+++ b/include/comm_navmsg.h
@@ -191,9 +191,9 @@ public:
   Nmea0183Msg(const std::string&amp; id)
      : Nmea0183Msg(id.size() &lt;= 3 ? std::string(&quot;??&quot;) + id : id, &quot;&quot;,
                    std::make_shared&lt;NavAddr&gt;(NavAddrNone())) {}
-  Nmea0183Msg(const Nmea0183Msg&amp; other, const std::string&amp; t)
-     : NavMsg(NavAddr::Bus::N0183, other.source), talker(other.talker),
-       type(t), payload(other.payload) {}
+  Nmea0183Msg(std::shared_ptr&lt;const Nmea0183Msg&gt; other, const std::string&amp; t)
+     : NavMsg(NavAddr::Bus::N0183, other-&gt;source), talker(other-&gt;talker),
+       type(t), payload(other-&gt;payload) {}

   std::string key() const { return std::string(&quot;n0183-&quot;) + type; };

diff --git a/src/comm_drv_n0183_serial.cpp b/src/comm_drv_n0183_serial.cpp
index 72fd090f8..5259a8b2b 100644
--- a/src/comm_drv_n0183_serial.cpp
+++ b/src/comm_drv_n0183_serial.cpp
@@ -302,15 +302,15 @@ void CommDriverN0183Serial::handle_N0183_MSG(
     // We notify based on full message, including the Talker ID
     identifier = full_sentence.substr(1, 5);

-    auto msg = std::make_unique&lt;const Nmea0183Msg&gt;(identifier, full_sentence,
+    auto msg = std::make_shared&lt;const Nmea0183Msg&gt;(identifier, full_sentence,
                                                    GetAddress());
     m_listener.Notify(std::move(msg));

     // Also notify for &quot;all&quot; N0183 messages, to support plugin API using
     // original talker id
     // FIXME
-    //auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(*msg, &quot;ALL&quot;);
-    //m_listener.Notify(std::move(msg_all));
+    auto msg_all = std::make_shared&lt;const Nmea0183Msg&gt;(msg, &quot;ALL&quot;);
+    m_listener.Notify(std::move(msg_all));
   }
 }

diff --git a/test/tests.cpp b/test/tests.cpp
index 55f17195b..5d46682fb 100644
--- a/test/tests.cpp
+++ b/test/tests.cpp
@@ -165,9 +165,9 @@ class All0183App: public wxAppConsole {
     Source() {
       std::string payload(&quot;payload data&quot;);
       std::string id(&quot;GPGGA&quot;);
-      auto msg1 = std::make_unique&lt;Nmea0183Msg&gt;(id, payload,
+      auto msg1 = std::make_shared&lt;Nmea0183Msg&gt;(id, payload,
                                                 shared_navaddr_none);
-      auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(*msg1, &quot;ALL&quot;);
+      auto msg_all = std::make_shared&lt;const Nmea0183Msg&gt;(msg1, &quot;ALL&quot;);
       NavMsgBus::GetInstance().Notify(std::move(msg_all));
     }
   };
</code></pre></div>



<a name="294648530"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294648530" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan Svensson <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294648530">(Aug 22 2022 at 10:45)</a>:</h4>
<p>Network connection crash...<br>
When I tried to compare the Look ahead mode above I connected "my" network TCP instead.<br>
That connection now made O to crash.<br>
While debugging the same it hangs here:</p>
<blockquote>
<div class="codehilite"><pre><span></span><code>      KernelBase.dll!75faca42()   Unknown
[Frames below may be incorrect and/or missing, no symbols loaded for KernelBase.dll]    Unknown
[External Code] 
opencpn.exe!Nmea0183Msg::Nmea0183Msg(const std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt; &amp; id, const std::basic_string&lt;char,std::char_traits&lt;char&gt;,std::allocator&lt;char&gt; &gt; &amp; _payload, std::shared_ptr&lt;NavAddr&gt; src) Line 187 C++
[External Code] 
opencpn.exe!CommDriverN0183Net::handle_N0183_MSG(CommDriverN0183NetEvent &amp; event) Line 171  C++
[External Code] 
opencpn.exe!PluginLoader::LoadPluginCandidate(wxString file_name, bool load_enabled) Line 340   C++
opencpn.exe!PluginLoader::LoadPlugInDirectory(const wxString &amp; plugin_dir, bool load_enabled) Line 444  C++
opencpn.exe!PluginLoader::LoadAllPlugIns(bool load_enabled) Line 234    C++
opencpn.exe!MyFrame::OnInitTimer(wxTimerEvent &amp; event) Line 5163    C++
[External Code] 
opencpn.exe!WinMain(HINSTANCE__ * hInstance, HINSTANCE__ * hPrevInstance, char * __formal, int nCmdShow) Line 945   C++
[External Code]
</code></pre></div>

</blockquote>
<p><a href="/user_uploads/33951/fYLLRCse4Cb3OSCtGosQUfBw/bild.png">bild.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/33951/fYLLRCse4Cb3OSCtGosQUfBw/bild.png" title="bild.png"><img src="/user_uploads/33951/fYLLRCse4Cb3OSCtGosQUfBw/bild.png"></a></div>



<a name="294662245"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294662245" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294662245">(Aug 22 2022 at 12:12)</a>:</h4>
<p>This is actually the same crash. EDITED</p>
<p>One problem is the use of <code>make_unique</code>.  The compiler implicitly converts it to a <code>shared_ptr</code>when invoking <code>Notify()</code>. However, it seems that this conversion in some situations casues loss of the correct destructor.  So, we should  apply this patch: </p>
<div class="codehilite"><pre><span></span><code>diff --git a/src/comm_drv_n0183_net.cpp b/src/comm_drv_n0183_net.cpp
index 6d3a32728..357e9cdd0 100644
--- a/src/comm_drv_n0183_net.cpp
+++ b/src/comm_drv_n0183_net.cpp
@@ -164,11 +164,11 @@ void CommDriverN0183Net::handle_N0183_MSG(CommDriverN0183NetEvent&amp; event) {
     // We notify based on Mnemonic only, ignoring the Talker ID
     identifier = full_sentence.substr(3, 3);

-    auto msg = std::make_unique&lt;const Nmea0183Msg&gt;(identifier, full_sentence, GetAddress());
+    auto msg = std::make_shared&lt;const Nmea0183Msg&gt;(identifier, full_sentence, GetAddress());
     m_listener.Notify(std::move(msg));

     // Also notify for &quot;all&quot; N0183 messages, to support plugin API
-    auto msg_all = std::make_unique&lt;const Nmea0183Msg&gt;(&quot;&quot;, full_sentence, GetAddress());
+    auto msg_all = std::make_shared&lt;const Nmea0183Msg&gt;(&quot;&quot;, full_sentence, GetAddress());
     m_listener.Notify(std::move(msg_all));
   }
 }
</code></pre></div>
<p>However, I doubt this is the root cause, a cause which I just don't see right now. However, there is a patch pending above which needs some testing to push things forward.</p>



<a name="294667167"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294667167" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294667167">(Aug 22 2022 at 12:42)</a>:</h4>
<p>Pushed a fix for <code>uniquie_ptr</code>-&gt; <code>shared_ptr</code>according to above</p>



<a name="294670650"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294670650" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294670650">(Aug 22 2022 at 13:01)</a>:</h4>
<p>I have pushed the patch in need of testing above to a "comm-n0183-id" temporary branch.</p>



<a name="294671942"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294671942" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294671942">(Aug 22 2022 at 13:07)</a>:</h4>
<p>Here is the stack trace, "comm" branch.<br>
<a href="/user_uploads/33951/5uADMX6MaQEoeJ9Dz5PcgTHM/comm.jpeg">comm.jpeg</a></p>
<div class="message_inline_image"><a href="/user_uploads/33951/5uADMX6MaQEoeJ9Dz5PcgTHM/comm.jpeg" title="comm.jpeg"><img src="/user_uploads/33951/5uADMX6MaQEoeJ9Dz5PcgTHM/comm.jpeg"></a></div>



<a name="294672314"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294672314" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294672314">(Aug 22 2022 at 13:09)</a>:</h4>
<p>Problem sees to do with copying the NavAddr field.</p>



<a name="294672738"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294672738" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294672738">(Aug 22 2022 at 13:11)</a>:</h4>
<p>I pulled before starting today, so this build already has the "make_shared" patch</p>



<a name="294681432"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294681432" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294681432">(Aug 22 2022 at 14:00)</a>:</h4>
<p>hm.. a bit narrow, that trace... </p>
<blockquote>
<p>Problem sees to do with copying the NavAddr field.</p>
</blockquote>
<p>Anyway, that thought has already occurred to me. But in which way? And why does the unit test work, whichever variant I use?</p>



<a name="294704823"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294704823" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294704823">(Aug 22 2022 at 14:58)</a>:</h4>
<p>I have tried to use also GetAddress() in the unit test, but still cannot reproduce the error.</p>
<p><span class="user-mention" data-user-id="517002">@Dave Register</span>  Could you make a smoke test with the  "comm-n0183-id" branch, which contains yet another permutation of the CTOR?</p>



<a name="294705607"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294705607" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294705607">(Aug 22 2022 at 15:02)</a>:</h4>
<p><span class="user-mention" data-user-id="517002">@Dave Register</span>  No, that branch is still broken. Please stay tuned...</p>



<a name="294710922"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294710922" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294710922">(Aug 22 2022 at 15:29)</a>:</h4>
<p><span class="user-mention" data-user-id="517002">@Dave Register</span>  Pushed a new version of "comm-n0183-id" branch The source (NavAddr) field is now const, and with some luck we should get a better stack trace, one statement per line... Could you possibly test?</p>



<a name="294735711"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294735711" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294735711">(Aug 22 2022 at 17:35)</a>:</h4>
<p>On "comm-n0183-id"<br>
<a href="/user_uploads/33951/XDYrX4KsM6YvYk_OpWb0Xcu2/comm1.jpeg">comm1.jpeg</a> <br>
 same fail.  Wider stack trace attached.</p>
<div class="message_inline_image"><a href="/user_uploads/33951/XDYrX4KsM6YvYk_OpWb0Xcu2/comm1.jpeg" title="comm1.jpeg"><img src="/user_uploads/33951/XDYrX4KsM6YvYk_OpWb0Xcu2/comm1.jpeg"></a></div>



<a name="294748786"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294748786" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294748786">(Aug 22 2022 at 18:56)</a>:</h4>
<p>Looking in comm-n0183-id@73a5f81d line 312 in comm_drv_n0183_serial.cpp is commented out. I assume that you uncommented it.</p>
<p>The plot thickens. Need to sleep on it. It seems pretty clear where it happens, but what? And why?</p>



<a name="294748811"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294748811" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294748811">(Aug 22 2022 at 18:56)</a>:</h4>
<p>BTW: Thanks!</p>



<a name="294750126"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294750126" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294750126">(Aug 22 2022 at 19:05)</a>:</h4>
<p>Hm... a compiler issue? The stacktrace indicates gcc version 7, 2017. I use gcc 12,  2022.  This should explain why I cannot reproduce the error. </p>
<p>gcc 7 means bionic, right? Is this the platform we should develop on? If we should support two versions on Ubuntu it would be Jammy and Focal...</p>



<a name="294750319"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294750319" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294750319">(Aug 22 2022 at 19:06)</a>:</h4>
<p>I'll fire up some VM:s and check, very late or tomorrow.</p>



<a name="294754274"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294754274" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294754274">(Aug 22 2022 at 19:32)</a>:</h4>
<p>FWIW, Bionic is still in LTS.</p>



<a name="294799021"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294799021" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294799021">(Aug 23 2022 at 03:54)</a>:</h4>
<p>Built on Focal(virtual), same error.<br>
Breakthrough:<br>
If I change the notify code to:</p>
<div class="codehilite"><pre><span></span><code>// We notify based on full message, including the Talker ID
identifier = full_sentence.substr(1, 5);

auto msg = std::make_shared&lt;const Nmea0183Msg&gt;(identifier, full_sentence,
                                               GetAddress());

// Also notify for &quot;all&quot; N0183 messages, to support plugin API using
// original talker id
auto msg_all = std::make_shared&lt;const Nmea0183Msg&gt;(*msg, &quot;ALL&quot;);

m_listener.Notify(std::move(msg));
m_listener.Notify(std::move(msg_all));
</code></pre></div>

<p>then it works.  All is well, the listener gets notified correctly, everybody happy. <br>
 I do not understand what std::move() does, exactly.  But after the first std::move(msg), evidently the "msg" is no longer valid.  So using it in the next copy constructor (for msg_all) fails, in some way.</p>



<a name="294824554"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294824554" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294824554">(Aug 23 2022 at 08:36)</a>:</h4>
<blockquote>
<p>But after the first std::move(msg), evidently the "msg" is no longer valid. So using it in the next copy constructor (for msg_all) fails, in some way.</p>
</blockquote>
<p>I also found it. This as as specified, any pointer is invalid after std::move. Using std::move on a shared pointer is not really necessary, it can just be assigned. However, if you know that the pointer wont be used any more std::move is much faster than just assigning (which involves thread-safe reference counter updates). </p>
<p>Anything in the message chain is IMHO performance sensitive, so it does makes sense to use it. But then you need to know what you are doing.  I should have spotted this much, much earlier. Sorry.</p>
<p>Made an update to comm-n0183-id-fix branch. I'm pretty sure that this works, but given the history of this problem it's probably better if you make a smoke test before merging it.</p>



<a name="294894235"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294894235" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294894235">(Aug 23 2022 at 15:40)</a>:</h4>
<p>Testing now.  Some trouble.  I'll track it down.</p>



<a name="294903271"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294903271" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294903271">(Aug 23 2022 at 16:24)</a>:</h4>
<p>Damned...</p>



<a name="294931373"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294931373" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Register <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294931373">(Aug 23 2022 at 19:16)</a>:</h4>
<p>Sorry, false alarm.  Troubles in the serial drivers.  Fixed, and committed.<br>
I think the comm msg interface is now in good shape.</p>



<a name="294934666"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/294934666" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alec Leamas <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#294934666">(Aug 23 2022 at 19:38)</a>:</h4>
<p>Nice. Working on making ais_decoder testable. On phone now, more later</p>



<a name="295695911"></a>
<h4><a href="https://opencpn.zulipchat.com#narrow/stream/332168-Master%20-%205.8.0%20%20%28was%3A%20comms%29/topic/n0183%20talker%20id%20handling/near/295695911" class="zl"><img src="https://leamas.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Håkan Svensson <a href="https://leamas.github.io/zulip-archive/stream/332168-Master---5.2E8.2E0--.28was.3A-comms.29/topic/n0183.20talker.20id.20handling.html#295695911">(Aug 28 2022 at 11:14)</a>:</h4>
<p>I can't follow the changes made but FWIW On Win built by VS2017:</p>
<p>"Network connection crash..." reported above is solved. I can use a network TCP connection again.</p>
<p>The also earlier reported O crash when changing from a serial N2K connection to a serial N0183 still remains though.<br>
<a href="/user_uploads/33951/5I6oIhRM5iDN2CPc1Ph-3pJE/bild.png">bild.png</a></p>
<div class="message_inline_image"><a href="/user_uploads/33951/5I6oIhRM5iDN2CPc1Ph-3pJE/bild.png" title="bild.png"><img src="/user_uploads/33951/5I6oIhRM5iDN2CPc1Ph-3pJE/bild.png"></a></div>



<hr><p>Last updated: Sep 14 2025 at 14:09 UTC</p>
</html>